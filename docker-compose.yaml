services:
  neo4j:
    image: neo4j:5
    restart: unless-stopped
    expose:
      - "7474"
      - "7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/changeme}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
    labels:
      - traefik.enable=true
      # Browser UI routing (port 7474)
      - traefik.http.routers.neo4j-http.entryPoints=http
      - traefik.http.routers.neo4j-http.rule=Host(`neo4j.eixamplefi.com`)
      - traefik.http.routers.neo4j-http.middlewares=redirect-to-https
      - traefik.http.routers.neo4j-https.entryPoints=https
      - traefik.http.routers.neo4j-https.rule=Host(`neo4j.eixamplefi.com`)
      - traefik.http.routers.neo4j-https.tls=true
      - traefik.http.routers.neo4j-https.tls.certresolver=letsencrypt
      - traefik.http.services.neo4j.loadbalancer.server.port=7474

volumes:
  neo4j_data:
  neo4j_logs:

# NOTE: Bolt routing (port 7687) is handled via Traefik file-based dynamic config,
# NOT via Docker labels. This avoids Traefik's "multiple services" conflict.
#
# Traefik entrypoint (in proxy docker-compose.yml):
#   --entrypoints.bolt.address=:7687
#
# Traefik dynamic config file (/data/coolify/proxy/dynamic/neo4j-bolt.yaml):
#   http:
#     routers:
#       neo4j-bolt:
#         rule: "Host(`neo4j.eixamplefi.com`)"
#         entryPoints: [bolt]
#         service: neo4j-bolt
#         tls:
#           certResolver: letsencrypt
#     services:
#       neo4j-bolt:
#         loadBalancer:
#           servers:
#             - url: "http://<container-name>:7687"
#
# Bolt uses WebSockets, so it routes via HTTP router (not TCP).
# Reference: github.com/Syndesi/neo4j-traefik-example
